<div class="categories-section">
  <div class="section-header">
    <h2>{{ showArchivedCategories ? 'Categorías Archivadas' : 'Categorías' }}</h2>
    <div class="header-actions">
      @if (canEdit && !showArchivedCategories) {
        <button class="btn-primary" (click)="openCreateForm()" [disabled]="loading">
          + Nueva Categoría
        </button>
      }
      @if (canEdit) {
        <div class="filter-tabs">
          <button 
            class="filter-tab" 
            [class.active]="!showArchivedCategories"
            (click)="showArchivedCategories = false; loadCategories()">
            Activas
          </button>
          <button 
            class="filter-tab" 
            [class.active]="showArchivedCategories"
            (click)="showArchivedCategories = true; loadCategories()">
            Archivadas
          </button>
        </div>
      }
    </div>
  </div>

  @if (error) {
    <div class="error-alert">
      {{ error }}
    </div>
  }

  @if (showForm && canEdit) {
    <div class="form-card">
      <h3>{{ editingCategory ? 'Editar' : 'Nueva' }} Categoría</h3>
      <form [formGroup]="categoryForm" (ngSubmit)="onSubmit()">
        @if (!editingCategory) {
          <div class="form-group">
            <label>Selecciona una categoría sugerida o crea una personalizada</label>
            <div class="suggested-categories">
              @for (suggested of suggestedCategories; track suggested) {
                <button
                  type="button"
                  class="suggested-category-btn"
                  [class.active]="useSuggestedCategory && selectedSuggestedCategory === suggested"
                  (click)="selectSuggestedCategory(suggested)">
                  {{ suggested }}
                </button>
              }
              <button
                type="button"
                class="suggested-category-btn custom"
                [class.active]="!useSuggestedCategory"
                (click)="useCustomCategory()">
                + Crear Personalizada
              </button>
            </div>
          </div>
        }
        <div class="form-group">
          <label for="name">Nombre *</label>
          <input
            id="name"
            type="text"
            formControlName="name"
            class="form-control"
            [class.is-invalid]="categoryForm.get('name')?.invalid && categoryForm.get('name')?.touched"
            [placeholder]="editingCategory ? 'Ej: Matemáticas' : (useSuggestedCategory ? 'Categoría seleccionada' : 'Ingresa el nombre de tu categoría')"
            [readonly]="useSuggestedCategory && !editingCategory"
          />
          @if (categoryForm.get('name')?.invalid && categoryForm.get('name')?.touched) {
            <div class="error-message">
              El nombre es obligatorio (mín. 3 caracteres)
            </div>
          }
        </div>

        <div class="form-group">
          <label for="description">Descripción</label>
          <textarea
            id="description"
            formControlName="description"
            class="form-control"
            rows="3"
            placeholder="Descripción opcional..."
          ></textarea>
        </div>

        <div class="form-actions">
          <button type="button" class="btn-secondary" (click)="closeForm()" [disabled]="loading">
            Cancelar
          </button>
          <button type="submit" class="btn-primary" [disabled]="categoryForm.invalid || loading">
            {{ loading ? 'Guardando...' : (editingCategory ? 'Actualizar' : 'Crear') }}
          </button>
        </div>
      </form>
    </div>
  }

  @if (loading && !showForm) {
    <div class="loading">Cargando categorías...</div>
  } @else if (!categories || categories.length === 0) {
    <div class="empty-state">
      <p>{{ showArchivedCategories ? 'No hay categorías archivadas' : 'No hay categorías disponibles' }}</p>
    </div>
  } @else {
    <div class="categories-grid">
      @for (category of categories; track category.id) {
        <div class="category-card">
          <div class="category-header">
            <h3>{{ category.name }}</h3>
            @if (canEdit) {
              <div class="card-actions">
                @if (category.status === 'ARCHIVED') {
                  <button class="btn-small btn-success" (click)="restoreCategory(category.id)" title="Restaurar">
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                      <path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path>
                      <polyline points="9 22 9 12 15 12 15 22"></polyline>
                    </svg>
                    Restaurar
                  </button>
                } @else {
                  <button class="btn-icon" (click)="openEditForm(category)" title="Editar">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                      <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path>
                      <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path>
                    </svg>
                  </button>
                  @if (hasPosts(category)) {
                    <button class="btn-icon btn-warning" (click)="archiveCategory(category.id)" title="Archivar">
                      <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <polyline points="21 8 21 21 3 21 3 8"></polyline>
                        <rect x="1" y="3" width="22" height="5"></rect>
                        <line x1="10" y1="12" x2="14" y2="12"></line>
                      </svg>
                    </button>
                  } @else {
                    <button class="btn-icon btn-danger" (click)="deleteCategory(category.id)" title="Eliminar">
                      <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <polyline points="3 6 5 6 21 6"></polyline>
                        <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
                      </svg>
                    </button>
                  }
                }
              </div>
            }
          </div>
          @if (category.description) {
            <p class="category-description">{{ category.description }}</p>
          }
          <div class="category-footer">
            <span class="badge">{{ category.posts_count || 0 }} posts</span>
            <span class="badge" [class]="getStatusBadgeClass(category.status)">
              {{ category.status }}
            </span>
          </div>
        </div>
      }
    </div>
  }
</div>

<app-confirm-delete-category
  [isOpen]="showDeleteModal"
  [categoryName]="selectedCategoryName"
  (confirm)="confirmDelete()"
  (cancel)="closeDeleteModal()">
</app-confirm-delete-category>


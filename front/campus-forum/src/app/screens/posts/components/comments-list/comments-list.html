<div class="comments-section">
  <h3>Comentarios ({{ comments.length }})</h3>

  @if (error) {
    <div class="error-alert">
      {{ error }}
    </div>
  }

  <!-- Formulario de nuevo comentario -->
  <div class="comment-form-card">
    <form [formGroup]="commentForm" (ngSubmit)="onSubmit()">
      <div class="form-group">
        <textarea
          formControlName="content"
          class="form-control"
          rows="3"
          placeholder="Escribe tu comentario..."
          [class.is-invalid]="commentForm.get('content')?.invalid && commentForm.get('content')?.touched"
        ></textarea>
        @if (commentForm.get('content')?.invalid && commentForm.get('content')?.touched) {
          <div class="error-message">
            El comentario debe tener al menos 5 caracteres
          </div>
        }
      </div>
      <button type="submit" class="btn-primary" [disabled]="commentForm.invalid || submitting">
        {{ submitting ? 'Publicando...' : 'Comentar' }}
      </button>
    </form>
  </div>

  <!-- Lista de comentarios -->
  @if (loading) {
    <div class="loading">Cargando comentarios...</div>
  } @else if (comments.length === 0) {
    <div class="empty-state">No hay comentarios aún. Sé el primero en comentar.</div>
  } @else {
    <div class="comments-list">
      @for (comment of comments; track comment.id) {
        <div class="comment-card">
          <div class="comment-header">
            <div class="comment-author">
              <strong>{{ comment.author.full_name }}</strong>
              <span class="comment-date">{{ formatDate(comment.created_at) }}</span>
            </div>
            <div class="comment-actions">
              @if (canDeleteComment(comment)) {
                <button class="btn-icon btn-danger" (click)="openDeleteModal(comment.id)" title="Eliminar">
                  <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <polyline points="3 6 5 6 21 6"></polyline>
                    <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
                  </svg>
                </button>
              } @else if (user) {
                <button class="btn-icon btn-report" (click)="openReportModal(comment.id)" title="Reportar">
                  <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M4 15s1-1 4-1 5 2 8 2 4-1 4-1V3s-1 1-4 1-5-2-8-2-4 1-4 1z"></path>
                    <line x1="4" y1="22" x2="4" y2="15"></line>
                  </svg>
                </button>
              }
            </div>
          </div>
          <p class="comment-content">{{ comment.content }}</p>
        </div>
      }
    </div>
  }

  <!-- Modales -->
  <app-confirm-delete-comment
    [isOpen]="showDeleteModal"
    (confirm)="confirmDelete()"
    (cancel)="closeDeleteModal()">
  </app-confirm-delete-comment>

  <app-report-comment
    [isOpen]="showReportModal"
    [commentId]="selectedCommentId"
    (close)="closeReportModal()"
    (reported)="onReported()">
  </app-report-comment>
</div>


